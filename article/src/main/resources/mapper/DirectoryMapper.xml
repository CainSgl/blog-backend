<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cainsgl.article.repository.DirectoryMapper">
    <!-- 映射 directory 表到 DirectoryEntity -->
    <resultMap id="DirectoryResultMap" type="com.cainsgl.common.entity.article.DirectoryEntity">
    </resultMap>
    
    <!-- 映射目录树结果 -->
    <resultMap id="DirectoryTreeResultMap" type="com.cainsgl.article.dto.DirectoryTreeDTO">
        <result column="id" property="id"/>
        <result column="kb_id" property="kbId"/>
        <result column="parent_id" property="parentId"/>
        <result column="name" property="name"/>
        <result column="post_id" property="postId"/>
        <result column="sort_num" property="sortNum"/>
    </resultMap>
    
    <!-- 通用列片段 -->
    <sql id="Base_Column_List">
        id, kb_id, parent_id, name, post_id, sort_num
    </sql>

    <!-- 递归查询知识库的完整目录树结构 -->
    <select id="getDirectoryTreeByKbId" resultMap="DirectoryTreeResultMap">
        WITH RECURSIVE dir_tree AS (
            -- 递归基：根目录（parent_id IS NULL）
            SELECT id, kb_id, parent_id, name, post_id, sort_num
            FROM directory
            WHERE kb_id = #{kbId}
              AND parent_id IS NULL
            UNION ALL
            -- 递归体：子目录
            SELECT d.id, d.kb_id, d.parent_id, d.name, d.post_id, d.sort_num
            FROM directory d
            JOIN dir_tree dt ON d.parent_id = dt.id
        )
        SELECT 
            id,
            kb_id,
            parent_id,
            name,
            post_id,
            sort_num
        FROM dir_tree
        ORDER BY sort_num
    </select>

    <!-- 递归获取指定目录及其所有子目录 -->
    <select id="getDirectoryAndSubdirectories" resultMap="DirectoryResultMap">
        WITH RECURSIVE dir_tree AS (
            -- 递归基：指定的目录
            SELECT id, kb_id, parent_id, name, post_id, sort_num
            FROM directory
            WHERE id = #{directoryId}
            UNION ALL
            -- 递归体：所有子目录
            SELECT d.id, d.kb_id, d.parent_id, d.name, d.post_id, d.sort_num
            FROM directory d
            JOIN dir_tree dt ON d.parent_id = dt.id
        )
        SELECT 
            id,
            kb_id,
            parent_id,
            name,
            post_id,
            sort_num
        FROM dir_tree
    </select>

    <!-- 更新目录信息（带知识库检验） -->
    <update id="updateDirectoryWithPermissionCheck">
        UPDATE directory
        <set>
            <if test="name != null">
                name = #{name},
            </if>
            parent_id = #{parentId},
        </set>
        WHERE id = #{directoryId}
          AND kb_id = #{kbId}
          AND user_id = #{userId}
    </update>
    <insert id="insertDirectoryWithValidation">
        INSERT INTO directory (id, kb_id, parent_id, name, post_id, user_id, sort_num)
        SELECT
            #{id, jdbcType=BIGINT},
            #{kbId, jdbcType=BIGINT},
            #{parentId, jdbcType=BIGINT},
            #{name, jdbcType=VARCHAR},
            #{postId, jdbcType=BIGINT},
            #{userId, jdbcType=BIGINT},
            -- 计算排序序号，使用当前子目录的最大sortNum加1
            COALESCE(
                    (SELECT MAX(sort_num) + 1
                     FROM directory
                     WHERE kb_id = #{kbId, jdbcType=BIGINT}
                       AND parent_id IS NOT DISTINCT FROM #{parentId, jdbcType=BIGINT}
                    ),
                    1
            )
        FROM knowledge_base kb
        WHERE kb.id = #{kbId, jdbcType=BIGINT}
          AND kb.user_id = #{userId, jdbcType=BIGINT}
          AND (
            -- 验证parent_id的kb_id一致性（如果parent_id不为空）
            #{parentId, jdbcType=BIGINT} IS NULL
                OR EXISTS (
                SELECT 1
                FROM directory d
                WHERE d.id = #{parentId, jdbcType=BIGINT}
                  AND d.kb_id = #{kbId, jdbcType=BIGINT}
            )
            )
    </insert>

    <!-- 获取目录（带权限验证） -->
    <select id="selectDirectoryWithPermissionCheck" resultMap="DirectoryResultMap">
        SELECT *
        FROM directory
        WHERE id = #{id}
          AND kb_id = #{kbId}
          AND user_id = #{userId}
    </select>

    <!-- 获取同级目录列表 -->
    <select id="selectSiblingDirectories" resultMap="DirectoryResultMap">
        SELECT *
        FROM directories
        WHERE kb_id = #{kbId}
          AND (
              <if test="parentId != null">
                  parent_id = #{parentId}
              </if>
              <if test="parentId == null">
                  parent_id IS NULL
              </if>
          )
        ORDER BY sort_num
    </select>

    <!-- 删除目录（带权限验证） -->
    <delete id="deleteDirectoryWithPermissionCheck">
        DELETE FROM directory
        WHERE id = #{id}
          AND kb_id = #{kbId}
          AND user_id = #{userId}
    </delete>
</mapper>
