# 文件前端直传使用说明

## 概述
前端直传功能允许文件直接从浏览器上传到对象存储（TOS），无需经过服务器中转，大幅提升上传效率并减轻服务器负担。

## 上传流程

### 1. 前端计算文件SHA256
```javascript
async function calculateSHA256(file) {
    const buffer = await file.arrayBuffer();
    const hashBuffer = await crypto.subtle.digest('SHA-256', buffer);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
}
```

### 2. 请求预签名上传凭证
```javascript
const file = document.getElementById('fileInput').files[0];
const sha256 = await calculateSHA256(file);

const response = await fetch('/file/presigned-upload', {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer YOUR_TOKEN'
    },
    body: JSON.stringify({
        filename: file.name,
        fileSize: file.size,
        sha256: sha256
    })
});

const data = await response.json();
```

### 3. 处理响应

#### 情况A：文件已存在（秒传）
```javascript
if (!data.needUpload) {
    console.log('文件已存在，秒传成功！文件ID:', data.fileId);
    // 直接使用 data.fileId 访问文件
    return;
}
```

#### 情况B：需要上传
```javascript
// 构建FormData
const formData = new FormData();
formData.append('key', data.key);
formData.append('policy', data.policy);
formData.append('x-tos-algorithm', data.algorithm);
formData.append('x-tos-credential', data.credential);
formData.append('x-tos-date', data.date);
formData.append('x-tos-signature', data.signature);
formData.append('file', file);  // file必须是最后一个字段

// 直接上传到TOS
const uploadResponse = await fetch(data.url, {
    method: 'POST',
    body: formData
});

if (uploadResponse.ok) {
    console.log('上传成功！文件ID:', data.fileId);
} else {
    console.error('上传失败:', await uploadResponse.text());
}
```

## 完整示例

```javascript
async function uploadFile(file) {
    try {
        // 1. 计算SHA256
        const sha256 = await calculateSHA256(file);
        
        // 2. 请求预签名凭证
        const response = await fetch('/file/presigned-upload', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer YOUR_TOKEN'
            },
            body: JSON.stringify({
                filename: file.name,
                fileSize: file.size,
                sha256: sha256
            })
        });
        
        const data = await response.json();
        
        // 3. 检查是否需要上传
        if (!data.needUpload) {
            console.log('文件秒传成功！');
            return data.fileId;
        }
        
        // 4. 构建表单并上传
        const formData = new FormData();
        formData.append('key', data.key);
        formData.append('policy', data.policy);
        formData.append('x-tos-algorithm', data.algorithm);
        formData.append('x-tos-credential', data.credential);
        formData.append('x-tos-date', data.date);
        formData.append('x-tos-signature', data.signature);
        formData.append('file', file);
        
        const uploadResponse = await fetch(data.url, {
            method: 'POST',
            body: formData
        });
        
        if (!uploadResponse.ok) {
            throw new Error('上传失败: ' + await uploadResponse.text());
        }
        
        console.log('上传成功！');
        return data.fileId;
        
    } catch (error) {
        console.error('上传出错:', error);
        throw error;
    }
}

// 使用示例
document.getElementById('fileInput').addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (file) {
        const fileId = await uploadFile(file);
        console.log('文件ID:', fileId);
        // 可以通过 /file?f={fileId} 访问文件
    }
});
```

## API说明

### POST /file/presigned-upload

**请求体：**
```json
{
    "filename": "example.jpg",
    "fileSize": 1024000,
    "sha256": "abc123..."
}
```

**响应（需要上传）：**
```json
{
    "url": "https://bucket.tos-cn-hongkong.volces.com",
    "key": "bucketfile/abc123.jpg",
    "policy": "eyJ...",
    "algorithm": "TOS4-HMAC-SHA256",
    "credential": "...",
    "date": "20260203T120000Z",
    "signature": "...",
    "fileId": 12345,
    "needUpload": true
}
```

**响应（文件已存在）：**
```json
{
    "fileId": 12345,
    "needUpload": false
}
```

## 优势

1. **减轻服务器负担**：文件不经过服务器，直接上传到对象存储
2. **提升上传速度**：减少一次网络传输
3. **支持秒传**：通过SHA256去重，相同文件无需重复上传
4. **安全可控**：使用预签名URL，有效期可控（默认1小时）

## 注意事项

1. FormData中的`file`字段必须放在最后
2. 预签名URL有效期为1小时，超时需重新获取
3. 前端需要支持Web Crypto API来计算SHA256
4. 上传失败时，服务器已创建的文件记录会保留，可以重试上传
