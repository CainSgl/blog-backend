# ç”¨æˆ·è¡¨è®¾è®¡æ–‡æ¡£
## ğŸ¯ è®¾è®¡æ¦‚è¿°
æœ¬ç”¨æˆ·è¡¨è®¾è®¡ä¸ºä¸ªäººåšå®¢ç³»ç»Ÿçš„æ ¸å¿ƒç”¨æˆ·æ•°æ®è¡¨ï¼Œå……åˆ†åˆ©ç”¨PostgreSQLæ•°æ®åº“ç‰¹æ€§ï¼Œå¹¶å®Œæ•´é›†æˆSaTokené‰´æƒç³»ç»Ÿã€‚
## ğŸ—ï¸ æŠ€æœ¯æ¶æ„
- **æ•°æ®åº“**: PostgreSQLï¼ˆåˆ©ç”¨å…¶é«˜çº§ç‰¹æ€§ï¼‰
- **IDç”Ÿæˆ**: MyBatis Plusé›ªèŠ±ç®—æ³•
- **é‰´æƒç³»ç»Ÿ**: SaToken
- **å¼€å‘æ¡†æ¶**: Spring Boot + MyBatis Plus
## ğŸ“Š è¡¨ç»“æ„è®¾è®¡
### æ ¸å¿ƒå­—æ®µè¯´æ˜
#### 1. ä¸»é”®IDè®¾è®¡
```sql
id BIGINT PRIMARY KEY DEFAULT nextval('snowflake_id_seq'::regclass)
```
- **é›ªèŠ±ç®—æ³•**: 64ä½åˆ†å¸ƒå¼IDï¼Œä¿è¯å…¨å±€å”¯ä¸€æ€§
- **è‡ªå¢åºåˆ—**: ä½¿ç”¨PostgreSQLåºåˆ—ç®¡ç†IDç”Ÿæˆ
- **æ€§èƒ½ä¼˜åŒ–**: ä¸»é”®ç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½
#### 2. SaTokené›†æˆå­—æ®µ
```sql
token_value VARCHAR(255) UNIQUE,              -- ç™»å½•tokenå€¼
token_expire_time TIMESTAMP WITH TIME ZONE,  -- Tokenè¿‡æœŸæ—¶é—´
login_ip VARCHAR(45),                        -- æœ€åç™»å½•IP
login_device VARCHAR(100),                   -- ç™»å½•è®¾å¤‡
login_browser VARCHAR(100),                  -- ç™»å½•æµè§ˆå™¨
login_os VARCHAR(100)                        -- ç™»å½•æ“ä½œç³»ç»Ÿ
```
**è®¾è®¡ä¼˜åŠ¿**:
- æ”¯æŒSaTokençš„å¤šç«¯ç™»å½•ç®¡ç†
- è®°å½•ç™»å½•è®¾å¤‡ä¿¡æ¯ï¼Œå¢å¼ºå®‰å…¨æ€§
- IPåœ°å€è®°å½•ç”¨äºå®‰å…¨å®¡è®¡
- æ”¯æŒå¤šç«¯åŒæ—¶åœ¨çº¿
#### 3. ç”¨æˆ·ç»Ÿè®¡å­—æ®µ
```sql
articles_count INTEGER DEFAULT 0,    -- å‘è¡¨æ–‡ç« æ•°é‡
comments_count INTEGER DEFAULT 0,    -- å‘è¡¨è¯„è®ºæ•°é‡
likes_received INTEGER DEFAULT 0,    -- æ”¶åˆ°çš„ç‚¹èµæ•°
likes_given INTEGER DEFAULT 0,       -- ç»™å‡ºçš„ç‚¹èµæ•°
followers_count INTEGER DEFAULT 0,   -- ç²‰ä¸æ•°é‡
following_count INTEGER DEFAULT 0    -- å…³æ³¨æ•°é‡
```
**è®¾è®¡æ€è·¯**:
- **æ•°æ®åº“æŒä¹…åŒ–**: ç¡®ä¿æ•°æ®ä¸€è‡´æ€§
- **Redisç¼“å­˜**: æä¾›é«˜æ€§èƒ½æ’è¡Œæ¦œæŸ¥è¯¢
- **å®šæ—¶åŒæ­¥**: Redisç¼“å­˜ä¸æ•°æ®åº“æ•°æ®åŒæ­¥
#### 4. æƒé™ç­‰çº§è®¾è®¡
```sql
status SMALLINT DEFAULT 1,           -- è´¦æˆ·çŠ¶æ€ï¼š0-ç¦ç”¨ï¼Œ1-æ­£å¸¸ï¼Œ2-å¾…æ¿€æ´»
role VARCHAR(50) DEFAULT 'USER',     -- ç”¨æˆ·è§’è‰²ï¼šADMIN, MODERATOR, USER
level SMALLINT DEFAULT 0             -- ç”¨æˆ·ç­‰çº§ï¼š0-æ™®é€šï¼Œ1-VIPï¼Œ2-ç®¡ç†å‘˜
```
**æƒé™ä½“ç³»**:
- **ä¸‰çº§æƒé™**: çŠ¶æ€æ§åˆ¶ â†’ è§’è‰²æ§åˆ¶ â†’ ç­‰çº§æ§åˆ¶
- **ç»†ç²’åº¦æ§åˆ¶**: æ”¯æŒç”¨æˆ·ç®¡ç†ã€å†…å®¹å®¡æ ¸ç­‰ä¸åŒæƒé™
- **å•†ä¸šåŒ–æ”¯æŒ**: VIPç­‰çº§ç³»ç»Ÿæ”¯æŒä»˜è´¹åŠŸèƒ½
## ğŸ”§ PostgreSQLç‰¹æ€§åˆ©ç”¨
### 1. è‡ªåŠ¨æ—¶é—´æˆ³æ›´æ–°
```sql
-- è§¦å‘å™¨å‡½æ•°
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;
-- è‡ªåŠ¨æ›´æ–°è§¦å‘å™¨
CREATE TRIGGER update_users_updated_at 
    BEFORE UPDATE ON users
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();
```
**ä¼˜åŠ¿**:
- **é›¶ä»£ç ç»´æŠ¤**: æ— éœ€æ‰‹åŠ¨æ›´æ–°æ—¶é—´æˆ³
- **æ•°æ®ä¸€è‡´æ€§**: ç¡®ä¿æ—¶é—´æˆ³å‡†ç¡®æ€§
- **æ€§èƒ½ä¼˜åŒ–**: æ•°æ®åº“å±‚é¢å¤„ç†ï¼Œå‡å°‘åº”ç”¨å±‚å¤æ‚åº¦
### 2. JSONBæ‰©å±•å­—æ®µ
```sql
preferences JSONB DEFAULT '{}'::jsonb
```
**åº”ç”¨åœºæ™¯**:
```json
{
  "theme": "dark",              -- ä¸»é¢˜åå¥½
  "language": "zh-CN",          -- è¯­è¨€è®¾ç½®
  "notification": {             -- é€šçŸ¥è®¾ç½®
    "email": true,
    "push": false,
    "comment": true,
    "like": true
  },
  "privacy": {                  -- éšç§è®¾ç½®
    "showActivity": true,
    "allowFollow": true
  }
}
```
**ä¼˜åŠ¿**:
- **ç»“æ„åŒ–å­˜å‚¨**: æ”¯æŒå¤æ‚é…ç½®é¡¹
- **çµæ´»æ‰©å±•**: æ— éœ€ä¿®æ”¹è¡¨ç»“æ„
- **æŸ¥è¯¢æ€§èƒ½**: JSONBç´¢å¼•æ”¯æŒé«˜æ•ˆæŸ¥è¯¢
### 3. æ—¶åŒºæ”¯æŒ
```sql
created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
```
**å¤šæ—¶åŒºæ”¯æŒ**:
- è‡ªåŠ¨å¤„ç†ä¸åŒæ—¶åŒºæ˜¾ç¤º
- å›½é™…åŒ–åº”ç”¨å‹å¥½
- æ—¶åŒºè½¬æ¢çµæ´»
## ğŸ“ˆ ç´¢å¼•ä¼˜åŒ–ç­–ç•¥
### 1. æ ¸å¿ƒæŸ¥è¯¢ç´¢å¼•
```sql
-- ç”¨æˆ·åç™»å½•ï¼ˆé«˜é¢‘æ“ä½œï¼‰
CREATE UNIQUE INDEX idx_users_username ON users(username);
-- é‚®ç®±ç™»å½•ï¼ˆé«˜é¢‘æ“ä½œï¼‰
CREATE UNIQUE INDEX idx_users_email ON users(email);
-- SaTokenéªŒè¯ï¼ˆé«˜é¢‘æ“ä½œï¼‰
CREATE UNIQUE INDEX idx_users_token ON users(token_value);
```
### 2. æ’è¡Œæ¦œç´¢å¼•
```sql
-- æ–‡ç« æ•°æ’è¡Œæ¦œ
CREATE INDEX idx_users_articles_count ON users(articles_count DESC);
-- å—æ¬¢è¿åº¦æ’è¡Œæ¦œ
CREATE INDEX idx_users_likes_received ON users(likes_received DESC);
-- ç²‰ä¸æ’è¡Œæ¦œ
CREATE INDEX idx_users_followers_count ON users(followers_count DESC);
```
### 3. ç­›é€‰ç´¢å¼•
```sql
-- çŠ¶æ€ç­›é€‰
CREATE INDEX idx_users_status ON users(status);
-- è§’è‰²ç­›é€‰
CREATE INDEX idx_users_role ON users(role);
-- æœ€æ–°æ³¨å†Œç”¨æˆ·
CREATE INDEX idx_users_created_at ON users(created_at DESC);
```
## ğŸ”’ å®‰å…¨è®¾è®¡
### 1. å¯†ç å®‰å…¨
- **åŠ å¯†å­˜å‚¨**: ä½¿ç”¨BCryptåŠ å¯†ç®—æ³•
- **ç›å€¼éšæœº**: æ¯ä¸ªå¯†ç ç‹¬ç«‹ç›å€¼
- **å¼ºåº¦éªŒè¯**: å‰ç«¯å’Œåç«¯åŒé‡éªŒè¯
### 2. ç™»å½•å®‰å…¨
- **è®¾å¤‡è®°å½•**: è®°å½•ç™»å½•è®¾å¤‡ä¿¡æ¯
- **IPè®°å½•**: ç™»å½•IPå®‰å…¨å®¡è®¡
- **Tokenç®¡ç†**: SaTokenè‡ªåŠ¨ç»­æœŸå’Œè¿‡æœŸå¤„ç†
### 3. åŒå› å­è®¤è¯æ”¯æŒ
```sql
two_factor_enabled BOOLEAN DEFAULT false,    -- æ˜¯å¦å¯ç”¨åŒå› å­è®¤è¯
two_factor_secret VARCHAR(255)               -- åŒå› å­è®¤è¯å¯†é’¥
```
## ğŸš€ æ€§èƒ½ä¼˜åŒ–
### 1. åˆ†é¡µæŸ¥è¯¢ä¼˜åŒ–
```sql
-- ç”¨æˆ·åˆ—è¡¨æŸ¥è¯¢ï¼ˆæ”¯æŒæ’åºå’Œè¿‡æ»¤ï¼‰
SELECT id, username, nickname, avatar_url, articles_count, likes_received
FROM users 
WHERE status = 1 
ORDER BY articles_count DESC 
LIMIT 20 OFFSET 0;
```
### 2. ç»Ÿè®¡æŸ¥è¯¢ä¼˜åŒ–
```sql
-- ç”¨æˆ·ç»Ÿè®¡ä¿¡æ¯æŸ¥è¯¢
SELECT 
    articles_count,
    comments_count,
    likes_received,
    followers_count
FROM users 
WHERE id = ?;
```
### 3. æ‰¹é‡æ“ä½œä¼˜åŒ–
```sql
-- æ‰¹é‡æ›´æ–°ç»Ÿè®¡æ•°æ®
UPDATE users SET 
    articles_count = (
        SELECT COUNT(*) FROM articles WHERE user_id = users.id
    ),
    updated_at = NOW()
WHERE id IN (...);
```
## ğŸ“ MyBatis Plusé…ç½®
### 1. å®ä½“ç±»é…ç½®
```java
@Data
@TableName("users")
public class User {
    
    @TableId(value = "id", type = IdType.ASSIGN_ID)
    private Long id;
    
    @TableField("username")
    private String username;
    
    @TableField("nickname")
    private String nickname;
    
    // ... å…¶ä»–å­—æ®µ
    
    // é›ªèŠ±ç®—æ³•é…ç½®
    @TableField(fill = FieldFill.INSERT)
    private LocalDateTime createdAt;
    
    @TableField(fill = FieldFill.INSERT_UPDATE)
    private LocalDateTime updatedAt;
}
```
### 2. è‡ªåŠ¨å¡«å……é…ç½®
```java
@Component
public class MyMetaObjectHandler implements MetaObjectHandler {
    
    @Override
    public void insertFill(MetaObject metaObject) {
        this.strictInsertFill(metaObject, "createdAt", LocalDateTime.class, LocalDateTime.now());
        this.strictInsertFill(metaObject, "updatedAt", LocalDateTime.class, LocalDateTime.now());
    }
    
    @Override
    public void updateFill(MetaObject metaObject) {
        this.strictUpdateFill(metaObject, "updatedAt", LocalDateTime.class, LocalDateTime.now());
    }
}
```
## ğŸ¯ åç»­æ‰©å±•è§„åˆ’
### 1. ç¤¾äº¤åŠŸèƒ½æ‰©å±•
- å¥½å‹ç³»ç»Ÿï¼š`user_friends`è¡¨
- ç§ä¿¡ç³»ç»Ÿï¼š`private_messages`è¡¨
- å…³æ³¨ç³»ç»Ÿï¼š`user_follows`è¡¨
### 2. å†…å®¹ç®¡ç†æ‰©å±•
- æ–‡ç« è‰ç¨¿ï¼š`article_drafts`è¡¨
- æ–‡ä»¶ç®¡ç†ï¼š`user_files`è¡¨
- å›æ”¶ç«™ï¼š`deleted_contents`è¡¨
### 3. è¿è¥åŠŸèƒ½æ‰©å±•
- ç”¨æˆ·è¡Œä¸ºç»Ÿè®¡ï¼š`user_activities`è¡¨
- ç³»ç»Ÿé€šçŸ¥ï¼š`system_notifications`è¡¨
- ä¸¾æŠ¥ç®¡ç†ï¼š`user_reports`è¡¨
## âœ… è´¨é‡ä¿è¯
### 1. æ•°æ®å®Œæ•´æ€§
- ä¸»é”®çº¦æŸç¡®ä¿å”¯ä¸€æ€§
- å¤–é”®çº¦æŸç¡®ä¿å¼•ç”¨å®Œæ•´æ€§
- æ£€æŸ¥çº¦æŸç¡®ä¿æ•°æ®æœ‰æ•ˆæ€§
### 2. å®‰å…¨æ€§
- SQLæ³¨å…¥é˜²æŠ¤
- XSSæ”»å‡»é˜²æŠ¤
- æ•æ„Ÿä¿¡æ¯åŠ å¯†
### 3. å¯ç»´æŠ¤æ€§
- æ¸…æ™°çš„å‘½åè§„èŒƒ
- å®Œæ•´çš„å­—æ®µæ³¨é‡Š
- è§„èŒƒçš„ç´¢å¼•è®¾è®¡